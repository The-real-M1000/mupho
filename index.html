<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MuPho - Música y Fotos</title>
    <style>
        .post {
            max-width: 500px;
            margin: 20px auto;
            padding: 10px;
            border: 1px solid #ccc;
        }
        .post img {
            max-width: 100%;
            cursor: pointer;
        }
        .likes, .comments {
            margin: 10px 0;
        }
        .comment {
            margin: 5px 0;
            padding: 5px;
            background: #f0f0f0;
        }
    </style>
</head>
<body>
    <div id="auth">
        <button id="loginBtn">Iniciar Sesión con Google</button>
        <button id="logoutBtn" style="display: none;">Cerrar Sesión</button>
    </div>

    <div id="upload" style="display: none;">
        <h2>Subir Nuevo Post</h2>
        <input type="file" id="imageInput" accept="image/*">
        <input type="file" id="audioInput" accept="audio/*">
        <button id="uploadBtn">Subir</button>
    </div>

    <div id="posts"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, arrayUnion, arrayRemove, query, orderBy } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-storage.js";

        // Tu configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDG1wZMBobltVFJ1SR_mDbt8INiw3ZxVdQ",
            authDomain: "mupho-ee0c0.firebaseapp.com",
            projectId: "mupho-ee0c0",
            storageBucket: "mupho-ee0c0.appspot.com",
            messagingSenderId: "753205321017",
            appId: "1:753205321017:web:d076264e8abdb7e5259ce8"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore();
        const storage = getStorage();
        let currentUser = null;

        // Autenticación
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const uploadDiv = document.getElementById('upload');

        loginBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error('Error de login:', error);
            }
        });

        logoutBtn.addEventListener('click', () => signOut(auth));

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'block';
                uploadDiv.style.display = 'block';
            } else {
                loginBtn.style.display = 'block';
                logoutBtn.style.display = 'none';
                uploadDiv.style.display = 'none';
            }
        });

        // Subida de archivos
        const uploadBtn = document.getElementById('uploadBtn');
        const imageInput = document.getElementById('imageInput');
        const audioInput = document.getElementById('audioInput');

        uploadBtn.addEventListener('click', async () => {
            if (!imageInput.files[0] || !audioInput.files[0]) {
                alert('Por favor selecciona una imagen y un archivo de audio');
                return;
            }

            const imageFile = imageInput.files[0];
            const audioFile = audioInput.files[0];

            try {
                // Subir imagen
                const imageRef = ref(storage, `images/${Date.now()}_${imageFile.name}`);
                await uploadBytes(imageRef, imageFile);
                const imageUrl = await getDownloadURL(imageRef);

                // Subir audio
                const audioRef = ref(storage, `audio/${Date.now()}_${audioFile.name}`);
                await uploadBytes(audioRef, audioFile);
                const audioUrl = await getDownloadURL(audioRef);

                // Guardar post en Firestore
                await addDoc(collection(db, 'posts'), {
                    imageUrl,
                    audioUrl,
                    userId: currentUser.uid,
                    userName: currentUser.displayName,
                    timestamp: new Date(),
                    likes: [],
                    comments: []
                });

                imageInput.value = '';
                audioInput.value = '';
            } catch (error) {
                console.error('Error al subir:', error);
                alert('Error al subir los archivos');
            }
        });

        // Mostrar posts
        const postsDiv = document.getElementById('posts');
        let currentAudio = null;

        const q = query(collection(db, 'posts'), orderBy('timestamp', 'desc'));
        onSnapshot(q, (snapshot) => {
            postsDiv.innerHTML = '';
            snapshot.forEach((doc) => {
                const post = doc.data();
                const postElement = document.createElement('div');
                postElement.className = 'post';
                
                // Imagen y audio
                const img = document.createElement('img');
                img.src = post.imageUrl;
                const audio = new Audio(post.audioUrl);
                
                // Control de reproducción
                img.addEventListener('click', () => {
                    if (currentAudio && currentAudio !== audio) {
                        currentAudio.pause();
                    }
                    if (audio.paused) {
                        audio.play();
                        currentAudio = audio;
                    } else {
                        audio.pause();
                    }
                });

                // Likes
                const likesDiv = document.createElement('div');
                likesDiv.className = 'likes';
                const likeBtn = document.createElement('button');
                likeBtn.textContent = `${post.likes.length} Me gusta`;
                likeBtn.disabled = !currentUser;
                
                if (currentUser) {
                    likeBtn.addEventListener('click', async () => {
                        const postRef = doc(db, 'posts', doc.id);
                        if (post.likes.includes(currentUser.uid)) {
                            await updateDoc(postRef, {
                                likes: arrayRemove(currentUser.uid)
                            });
                        } else {
                            await updateDoc(postRef, {
                                likes: arrayUnion(currentUser.uid)
                            });
                        }
                    });
                }

                // Comentarios
                const commentsDiv = document.createElement('div');
                commentsDiv.className = 'comments';
                post.comments.forEach(comment => {
                    const commentElement = document.createElement('div');
                    commentElement.className = 'comment';
                    commentElement.textContent = `${comment.userName}: ${comment.text}`;
                    commentsDiv.appendChild(commentElement);
                });

                if (currentUser) {
                    const commentInput = document.createElement('input');
                    commentInput.placeholder = 'Escribe un comentario...';
                    const commentBtn = document.createElement('button');
                    commentBtn.textContent = 'Comentar';
                    
                    commentBtn.addEventListener('click', async () => {
                        if (commentInput.value.trim()) {
                            const postRef = doc(db, 'posts', doc.id);
                            await updateDoc(postRef, {
                                comments: arrayUnion({
                                    userId: currentUser.uid,
                                    userName: currentUser.displayName,
                                    text: commentInput.value.trim(),
                                    timestamp: new Date()
                                })
                            });
                            commentInput.value = '';
                        }
                    });

                    commentsDiv.appendChild(commentInput);
                    commentsDiv.appendChild(commentBtn);
                }

                postElement.appendChild(img);
                postElement.appendChild(likesDiv);
                likesDiv.appendChild(likeBtn);
                postElement.appendChild(commentsDiv);
                postsDiv.appendChild(postElement);
            });
        });
    </script>
</body>
</html>
