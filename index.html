<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subir Imagen y Audio</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
</head>
<body>
    <h2>Autenticación</h2>
    <button id="loginBtn">Iniciar Sesión con Google</button>
    <button id="logoutBtn" style="display: none;">Cerrar Sesión</button>
    <p id="userInfo"></p>

    <h2>Subir Imagen y Audio</h2>
    <label>Selecciona una imagen:</label>
    <input type="file" id="imageInput" accept="image/*">
    <br><br>

    <label>Selecciona un audio:</label>
    <input type="file" id="audioInput" accept="audio/*">
    <br><br>

    <button id="uploadBtn">Subir Post</button>

    <h2>Posts Subidos</h2>
    <div id="posts"></div>

    <script>
        // 🔹 Configuración de Supabase
        const SUPABASE_URL = "https://htrtamxepujazvxngekg.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0cnRhbXhlcHVqYXp2eG5nZWtnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg5OTI2NjgsImV4cCI6MjA1NDU2ODY2OH0.eUSM2NcjZ3389NCLpbfoeeHh4RJe7xG6SCZ33iyeLYU";
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // 🔹 Elementos del DOM
        const loginBtn = document.getElementById("loginBtn");
        const logoutBtn = document.getElementById("logoutBtn");
        const userInfo = document.getElementById("userInfo");

        // 🔹 Autenticación con Supabase
        loginBtn.addEventListener("click", async () => {
            try {
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.origin
                    }
                });

                if (error) throw error;
                console.log("Login iniciado:", data);
            } catch (error) {
                console.error("Error en el login:", error);
                alert("Error al iniciar sesión: " + error.message);
            }
        });

        logoutBtn.addEventListener("click", async () => {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                console.log("Sesión cerrada exitosamente");
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
                alert("Error al cerrar sesión: " + error.message);
            }
        });

        // 🔹 Observador del estado de autenticación
        supabase.auth.onAuthStateChange((event, session) => {
            console.log("Estado de auth cambiado:", event, session);
            if (session) {
                userInfo.textContent = `Bienvenido, ${session.user.email}`;
                loginBtn.style.display = "none";
                logoutBtn.style.display = "block";
            } else {
                userInfo.textContent = "";
                loginBtn.style.display = "block";
                logoutBtn.style.display = "none";
            }
        });

        // 🔹 Subir archivos a Supabase Storage
        async function uploadFile(file, bucket) {
            if (!file) return null;

            try {
                const fileName = `${Date.now()}-${file.name}`;
                const { data, error } = await supabase.storage
                    .from(bucket)
                    .upload(fileName, file);

                if (error) throw error;

                const { data: urlData } = supabase.storage
                    .from(bucket)
                    .getPublicUrl(fileName);

                return urlData.publicUrl;
            } catch (error) {
                console.error(`Error al subir ${bucket}:`, error);
                alert(`Error al subir el archivo de ${bucket}: ${error.message}`);
                return null;
            }
        }

        // 🔹 Subir un post (imagen + audio)
        async function uploadPost() {
            const session = await supabase.auth.getSession();
            if (!session.data.session) {
                alert("Debes iniciar sesión para subir un post.");
                return;
            }

            const audioFile = document.getElementById("audioInput").files[0];
            const imageFile = document.getElementById("imageInput").files[0];

            if (!audioFile || !imageFile) {
                alert("Selecciona una imagen y un audio.");
                return;
            }

            try {
                const audioUrl = await uploadFile(audioFile, "audio");
                const imageUrl = await uploadFile(imageFile, "imagen");

                if (!audioUrl || !imageUrl) {
                    throw new Error("Error al subir los archivos");
                }

                const { error } = await supabase
                    .from("posts")
                    .insert([{
                        imagen: imageUrl,
                        audio: audioUrl,
                        usuario: session.data.session.user.email,
                        fecha: new Date().toISOString()
                    }]);

                if (error) throw error;

                alert("Post subido correctamente.");
                document.getElementById("imageInput").value = "";
                document.getElementById("audioInput").value = "";
                await fetchPosts();
            } catch (error) {
                console.error("Error al subir post:", error);
                alert("Error al subir el post: " + error.message);
            }
        }

        // 🔹 Obtener y mostrar posts
        async function fetchPosts() {
            try {
                const { data, error } = await supabase
                    .from("posts")
                    .select("*")
                    .order("fecha", { ascending: false });

                if (error) throw error;

                const postsDiv = document.getElementById("posts");
                postsDiv.innerHTML = "";

                data.forEach(post => {
                    const postElement = document.createElement("div");
                    postElement.innerHTML = `
                        <h3>${post.usuario}</h3>
                        <img src="${post.imagen}" style="max-width: 200px;">
                        <br>
                        <audio controls src="${post.audio}"></audio>
                        <p>${new Date(post.fecha).toLocaleString()}</p>
                        <hr>
                    `;
                    postsDiv.appendChild(postElement);
                });
            } catch (error) {
                console.error("Error al obtener posts:", error);
                alert("Error al cargar los posts: " + error.message);
            }
        }

        // 🔹 Event listeners
        document.getElementById("uploadBtn").addEventListener("click", uploadPost);
        document.addEventListener("DOMContentLoaded", fetchPosts);

        // 🔹 Verificar sesión al cargar
        async function checkSession() {
            const { data: { session }, error } = await supabase.auth.getSession();
            if (session) {
                userInfo.textContent = `Bienvenido, ${session.user.email}`;
                loginBtn.style.display = "none";
                logoutBtn.style.display = "block";
            }
        }
        checkSession();
    </script>
</body>
</html>
