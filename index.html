<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subir Imagen y Audio</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <!-- Actualizaci贸n de las versiones de Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
</head>
<body>
    <h2>Autenticaci贸n</h2>
    <button id="loginBtn">Iniciar Sesi贸n con Google</button>
    <button id="logoutBtn" style="display: none;">Cerrar Sesi贸n</button>
    <p id="userInfo"></p>

    <h2>Subir Imagen y Audio</h2>
    <label>Selecciona una imagen:</label>
    <input type="file" id="imageInput" accept="image/*">
    <br><br>

    <label>Selecciona un audio:</label>
    <input type="file" id="audioInput" accept="audio/*">
    <br><br>

    <button id="uploadBtn">Subir Post</button>

    <h2>Posts Subidos</h2>
    <div id="posts"></div>

    <script>
        //  Configuraci贸n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDG1wZMBobltVFJ1SR_mDbt8INiw3ZxVdQ",
            authDomain: "mupho-ee0c0.firebaseapp.com",
            projectId: "mupho-ee0c0",
            storageBucket: "mupho-ee0c0.firebasestorage.app",
            messagingSenderId: "753205321017",
            appId: "1:753205321017:web:d076264e8abdb7e5259ce8",
            measurementId: "G-CX2RXMBBQH"
        };

        // Inicializaci贸n de Firebase con manejo de errores
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            console.log("Firebase inicializado correctamente");
        } catch (error) {
            console.error("Error al inicializar Firebase:", error);
        }

        const auth = firebase.auth();
        const provider = new firebase.auth.GoogleAuthProvider();

        //  Configuraci贸n de Supabase
        const SUPABASE_URL = "https://htrtamxepujazvxngekg.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0cnRhbXhlcHVqYXp2eG5nZWtnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg5OTI2NjgsImV4cCI6MjA1NDU2ODY2OH0.eUSM2NcjZ3389NCLpbfoeeHh4RJe7xG6SCZ33iyeLYU";
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        //  Autenticaci贸n con Firebase - Mejorada
        const loginBtn = document.getElementById("loginBtn");
        const logoutBtn = document.getElementById("logoutBtn");
        const userInfo = document.getElementById("userInfo");

        loginBtn.addEventListener("click", async () => {
            try {
                console.log("Iniciando proceso de login...");
                provider.setCustomParameters({
                    prompt: 'select_account'
                });
                const result = await auth.signInWithPopup(provider);
                console.log("Login exitoso:", result.user.displayName);
            } catch (error) {
                console.error("Error detallado en el login:", error);
                let errorMessage = "Error al iniciar sesi贸n";
                if (error.code) {
                    switch (error.code) {
                        case 'auth/popup-blocked':
                            errorMessage = "El popup fue bloqueado. Por favor, permite ventanas emergentes para este sitio.";
                            break;
                        case 'auth/popup-closed-by-user':
                            errorMessage = "El proceso de login fue cancelado.";
                            break;
                        case 'auth/unauthorized-domain':
                            errorMessage = "Este dominio no est谩 autorizado para la autenticaci贸n.";
                            break;
                        default:
                            errorMessage = `Error: ${error.message}`;
                    }
                }
                alert(errorMessage);
            }
        });

        logoutBtn.addEventListener("click", async () => {
            try {
                await auth.signOut();
                console.log("Cierre de sesi贸n exitoso");
            } catch (error) {
                console.error("Error al cerrar sesi贸n:", error);
                alert("Error al cerrar sesi贸n: " + error.message);
            }
        });

        auth.onAuthStateChanged((user) => {
            console.log("Estado de autenticaci贸n cambiado:", user ? "Usuario logueado" : "Usuario no logueado");
            if (user) {
                userInfo.textContent = `Bienvenido, ${user.displayName}`;
                loginBtn.style.display = "none";
                logoutBtn.style.display = "block";
            } else {
                userInfo.textContent = "";
                loginBtn.style.display = "block";
                logoutBtn.style.display = "none";
            }
        });

        // [El resto del c贸digo permanece igual...]
        
        //  Subir archivos a Supabase Storage
        async function uploadFile(file, bucket) {
            if (!file) return null;

            try {
                const fileName = `${Date.now()}-${file.name}`;
                const { data, error } = await supabase.storage
                    .from(bucket)
                    .upload(fileName, file);

                if (error) throw error;

                const { data: urlData } = supabase.storage
                    .from(bucket)
                    .getPublicUrl(fileName);

                return urlData.publicUrl;
            } catch (error) {
                console.error(`Error al subir ${bucket}:`, error);
                alert(`Error al subir el archivo de ${bucket}: ${error.message}`);
                return null;
            }
        }

        //  Subir un post (imagen + audio)
        async function uploadPost() {
            const user = auth.currentUser;
            if (!user) {
                alert("Debes iniciar sesi贸n para subir un post.");
                return;
            }

            const audioFile = document.getElementById("audioInput").files[0];
            const imageFile = document.getElementById("imageInput").files[0];

            if (!audioFile || !imageFile) {
                alert("Selecciona una imagen y un audio.");
                return;
            }

            try {
                const audioUrl = await uploadFile(audioFile, "audio");
                const imageUrl = await uploadFile(imageFile, "imagen");

                if (!audioUrl || !imageUrl) {
                    throw new Error("Error al subir los archivos");
                }

                const { error } = await supabase
                    .from("posts")
                    .insert([{
                        imagen: imageUrl,
                        audio: audioUrl,
                        usuario: user.displayName,
                        fecha: new Date().toISOString()
                    }]);

                if (error) throw error;

                alert("Post subido correctamente.");
                document.getElementById("imageInput").value = "";
                document.getElementById("audioInput").value = "";
                await fetchPosts();
            } catch (error) {
                console.error("Error al subir post:", error);
                alert("Error al subir el post: " + error.message);
            }
        }

        //  Obtener y mostrar posts
        async function fetchPosts() {
            try {
                const { data, error } = await supabase
                    .from("posts")
                    .select("*")
                    .order("fecha", { ascending: false });

                if (error) throw error;

                const postsDiv = document.getElementById("posts");
                postsDiv.innerHTML = "";

                data.forEach(post => {
                    const postElement = document.createElement("div");
                    postElement.innerHTML = `
                        <h3>${post.usuario}</h3>
                        <img src="${post.imagen}" style="max-width: 200px;">
                        <br>
                        <audio controls src="${post.audio}"></audio>
                        <p>${new Date(post.fecha).toLocaleString()}</p>
                        <hr>
                    `;
                    postsDiv.appendChild(postElement);
                });
            } catch (error) {
                console.error("Error al obtener posts:", error);
                alert("Error al cargar los posts: " + error.message);
            }
        }

        //  Event listeners
        document.getElementById("uploadBtn").addEventListener("click", uploadPost);
        document.addEventListener("DOMContentLoaded", fetchPosts);
    </script>
</body>
</html>
