<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subir Imagen y Audio</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.3.0/firebase-auth.js"></script>
</head>
<body>
    <h2>Autenticaci贸n</h2>
    <button id="loginBtn">Iniciar Sesi贸n con Google</button>
    <button id="logoutBtn" style="display: none;">Cerrar Sesi贸n</button>
    <p id="userInfo"></p>

    <h2>Subir Imagen y Audio</h2>
    <label>Selecciona una imagen:</label>
    <input type="file" id="imageInput" accept="image/*">
    <br><br>

    <label>Selecciona un audio:</label>
    <input type="file" id="audioInput" accept="audio/*">
    <br><br>

    <button id="uploadBtn">Subir Post</button>

    <h2>Posts Subidos</h2>
    <div id="posts"></div>

    <script type="module">
        //  Conectar con Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDG1wZMBobltVFJ1SR_mDbt8INiw3ZxVdQ",
            authDomain: "mupho-ee0c0.firebaseapp.com",
            projectId: "mupho-ee0c0",
            storageBucket: "mupho-ee0c0.firebasestorage.app",
            messagingSenderId: "753205321017",
            appId: "1:753205321017:web:d076264e8abdb7e5259ce8",
            measurementId: "G-CX2RXMBBQH"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const provider = new GoogleAuthProvider();

        const loginBtn = document.getElementById("loginBtn");
        const logoutBtn = document.getElementById("logoutBtn");
        const userInfo = document.getElementById("userInfo");

        loginBtn.addEventListener("click", async () => {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Error en el login:", error);
            }
        });

        logoutBtn.addEventListener("click", () => signOut(auth));

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userInfo.textContent = `Bienvenido, ${user.displayName}`;
                loginBtn.style.display = "none";
                logoutBtn.style.display = "block";
            } else {
                userInfo.textContent = "";
                loginBtn.style.display = "block";
                logoutBtn.style.display = "none";
            }
        });

        //  Conectar con Supabase
        const SUPABASE_URL = "https://htrtamxepujazvxngekg.supabase.co";
        const SUPABASE_KEY = "TU-CLAVE-ANON";
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function uploadFile(file, bucket) {
            if (!file) {
                alert("Selecciona un archivo.");
                return null;
            }

            const fileName = `${bucket}/${Date.now()}-${file.name}`;
            const { data, error } = await supabase.storage
                .from(bucket)
                .upload(fileName, file);

            if (error) {
                console.error(`Error al subir ${bucket}:`, error);
                alert(`Error al subir el archivo de ${bucket}.`);
                return null;
            }

            const { publicUrl } = supabase.storage.from(bucket).getPublicUrl(fileName);
            return publicUrl;
        }

        async function uploadPost() {
            const user = auth.currentUser;
            if (!user) {
                alert("Debes iniciar sesi贸n para subir un post.");
                return;
            }

            const audioFile = document.getElementById("audioInput").files[0];
            const imageFile = document.getElementById("imageInput").files[0];

            if (!audioFile || !imageFile) {
                alert("Selecciona una imagen y un audio.");
                return;
            }

            const audioUrl = await uploadFile(audioFile, "audio");
            const imageUrl = await uploadFile(imageFile, "imagen");

            if (!audioUrl || !imageUrl) {
                alert("Error al subir los archivos.");
                return;
            }

            const { data, error } = await supabase
                .from("posts")
                .insert([{ 
                    imagen: imageUrl, 
                    audio: audioUrl, 
                    usuario: user.displayName,
                    fecha: new Date() 
                }]);

            if (error) {
                console.error("Error al guardar en la base de datos:", error);
                alert("Error al guardar en la base de datos.");
                return;
            }

            alert("Post subido correctamente.");
            fetchPosts();
        }

        async function fetchPosts() {
            const { data, error } = await supabase.from("posts").select("*").order("fecha", { ascending: false });

            if (error) {
                console.error("Error al obtener posts:", error);
                return;
            }

            const postsDiv = document.getElementById("posts");
            postsDiv.innerHTML = "";

            data.forEach(post => {
                const postElement = document.createElement("div");
                postElement.innerHTML = `
                    <h3>${post.usuario}</h3>
                    <img src="${post.imagen}" style="max-width: 200px;">
                    <br>
                    <audio controls src="${post.audio}"></audio>
                    <p>${new Date(post.fecha).toLocaleString()}</p>
                    <hr>
                `;
                postsDiv.appendChild(postElement);
            });
        }

        document.getElementById("uploadBtn").addEventListener("click", uploadPost);
        document.addEventListener("DOMContentLoaded", fetchPosts);
    </script>
</body>
</html>
